{"version":3,"sources":["../../src/middlewares/resources-middleware.js"],"names":["update_middleware","req","res","next","KingdomService","getAllKingdomsByUserId","user","id","kingdoms","kingdom","currentTick","Math","floor","Date","now","elapsedTicks","lastTick","tick_length","resourcesService","updateResources"],"mappings":";;;;;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;;;;;;;AAEA,IAAMA,iBAAiB;AAAA,2FAAG,iBAAOC,GAAP,EAAYC,GAAZ,EAAiBC,IAAjB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAEHC,2BAAeC,sBAAf,CAAsCJ,GAAG,CAACK,IAAJ,CAASC,EAA/C,CAFG;;AAAA;AAEpBC,YAAAA,QAFoB;;AAAA,iBAGpBA,QAHoB;AAAA;AAAA;AAAA;;AAAA,mDAKFA,QALE;AAAA;;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAKbC,YAAAA,OALa;AAMpB;AACIC,YAAAA,WAPgB,GAOFC,IAAI,CAACC,KAAL,CAAWC,IAAI,CAACC,GAAL,KAAa,IAAxB,CAPE;AAQhBC,YAAAA,YARgB,GAQD,CAACL,WAAW,GAAGD,OAAO,CAACO,QAAvB,IAAmC,oBAAQC,WAR1C;AASpBF,YAAAA,YAAY,GAAGJ,IAAI,CAACC,KAAL,CAAWG,YAAX,CAAf,CAToB,CAWpB;;AAXoB,kBAYhBA,YAAY,KAAK,CAZD;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;AAAA,mBAgBdG,6BAAiBC,eAAjB,CAAiCV,OAAjC,EAA0CC,WAA1C,CAhBc;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;;AAAA;;AAAA;;AAAA;AAqBxBP,YAAAA,IAAI;;AArBoB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAH;;AAAA,kBAAjBH,iBAAiB;AAAA;AAAA;AAAA,GAAvB;;eAwBeA,iB","sourcesContent":["import {rules} from \"../rules/rules\";\nimport KingdomService from \"../services/kingdom-service\";\nimport BuildingService from \"../services/building-service\";\nimport TroopsService from \"../services/troops-services/troops-service\";\nimport resourcesService from \"../services/resources-service\";\n\nconst update_middleware = async (req, res, next) => {\n\n  let kingdoms = await KingdomService.getAllKingdomsByUserId(req.user.id);\n  if (kingdoms) {\n\n    for (let kingdom of kingdoms) {\n      //how many whole ticks elapsed from last sync\n      let currentTick = Math.floor(Date.now() / 1000);\n      let elapsedTicks = (currentTick - kingdom.lastTick) / rules().tick_length;\n      elapsedTicks = Math.floor(elapsedTicks);\n\n      //if no tick elapsed, skip to next Kingdom\n      if (elapsedTicks === 0) {\n        continue;\n      }\n\n      await resourcesService.updateResources(kingdom, currentTick);\n\n    }\n  }\n\n  next();\n};\n\nexport default update_middleware;\n"],"file":"resources-middleware.js"}